name: Update Data

# Run every 6 hours and allow manual trigger
on:
  schedule:
    # Runs at 00:00, 06:00, 12:00, 18:00 UTC daily
    - cron: '0 */6 * * *'
  
  # Allow manual trigger from GitHub Actions tab
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      # 3. Install dependencies
      - name: Install dependencies
        run: npm ci
      
      # 4. Run data collection script
      - name: Fetch all data
        run: node scripts/fetch-all-data.js
        env:
          HDX_API_KEY: ${{ secrets.HDX_API_KEY }}
      
      # 5. Check if data changed
      - name: Check for changes
        id: check_changes
        run: |
          if git diff --quiet public/data/; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No data changes detected"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Data changes detected"
          fi
      
      # 6. Commit and push if data changed
      - name: Commit and push changes
        if: steps.check_changes.outputs.changed == 'true'
        run: |
          git config --local user.name "Data Update Bot"
          git config --local user.email "bot@palboard.net"
          git add public/data/
          git commit -m "🤖 Auto-update data: $(date -u '+%Y-%m-%d %H:%M UTC')"
          git push
      
      # 7. Summary
      - name: Summary
        run: |
          if [ "${{ steps.check_changes.outputs.changed }}" == "true" ]; then
            echo "✅ Data updated and pushed to repository"
            echo "📊 Netlify will automatically deploy the changes"
          else
            echo "ℹ️ No data changes - skipping commit"
          fi
