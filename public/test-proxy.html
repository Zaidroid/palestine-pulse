<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Proxy Test - Palestine Pulse</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            color: #CC2936;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-item {
            padding: 10px;
            margin: 10px 0;
            border-left: 4px solid #ddd;
            background: #f9f9f9;
        }
        .test-item.success {
            border-left-color: #4CAF50;
            background: #f1f8f4;
        }
        .test-item.failed {
            border-left-color: #f44336;
            background: #fef1f0;
        }
        .test-item.testing {
            border-left-color: #2196F3;
            background: #e3f2fd;
        }
        button {
            background: #CC2936;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #a82129;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .summary {
            font-size: 18px;
            font-weight: bold;
            margin: 20px 0;
        }
        .summary.success {
            color: #4CAF50;
        }
        .summary.failed {
            color: #f44336;
        }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            font-size: 12px;
        }
        .response-time {
            color: #666;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <h1>üîå API Proxy Connectivity Test</h1>
    <p>This page tests the Vite proxy configuration by making requests through the dev server.</p>
    
    <div>
        <button onclick="runAllTests()">Run All Tests</button>
        <button onclick="clearResults()">Clear Results</button>
    </div>

    <div id="summary" class="summary"></div>

    <div class="test-section">
        <h2>üìä Tech4Palestine API</h2>
        <div id="tech4palestine-results"></div>
    </div>

    <div class="test-section">
        <h2>üêë Good Shepherd Collective API</h2>
        <div id="goodshepherd-results"></div>
    </div>

    <div class="test-section">
        <h2>üè¶ World Bank API</h2>
        <div id="worldbank-results"></div>
    </div>

    <div class="test-section">
        <h2>üåê UN OCHA / HDX API</h2>
        <div id="ocha-results"></div>
    </div>

    <div class="test-section">
        <h2>üìç B'Tselem API</h2>
        <div id="btselem-results"></div>
    </div>

    <script>
        const tests = [
            // Tech4Palestine
            { source: 'tech4palestine', endpoint: '/api/tech4palestine/v3/summary.json', name: 'Summary Statistics' },
            { source: 'tech4palestine', endpoint: '/api/tech4palestine/v3/killed-in-gaza.min.json', name: 'Gaza Casualties' },
            { source: 'tech4palestine', endpoint: '/api/tech4palestine/v2/press_killed_in_gaza.json', name: 'Press Casualties' },
            { source: 'tech4palestine', endpoint: '/api/tech4palestine/v2/casualties_daily.json', name: 'Daily Casualties' },
            
            // Good Shepherd
            { source: 'goodshepherd', endpoint: '/api/goodshepherd/wb_data.json', name: 'West Bank Data' },
            { source: 'goodshepherd', endpoint: '/api/goodshepherd/child_prisoners.json', name: 'Child Prisoners' },
            { source: 'goodshepherd', endpoint: '/api/goodshepherd/healthcare_attacks.json', name: 'Healthcare Attacks' },
            
            // World Bank
            { source: 'worldbank', endpoint: '/api/worldbank/countries/PSE/indicators?format=json', name: 'Palestine Indicators' },
            
            // UN OCHA (direct, no proxy)
            { source: 'ocha', endpoint: 'https://data.humdata.org/api/action/package_search?q=organization:un-ocha&rows=1', name: 'OCHA Datasets' },
            
            // B'Tselem
            { source: 'btselem', endpoint: '/api/btselem/checkpoints', name: 'Checkpoint Data' },
        ];

        let results = [];

        async function testEndpoint(test) {
            const resultDiv = document.getElementById(`${test.source}-results`);
            const testItem = document.createElement('div');
            testItem.className = 'test-item testing';
            testItem.innerHTML = `<strong>${test.name}</strong><br><span class="response-time">Testing...</span>`;
            resultDiv.appendChild(testItem);

            const startTime = Date.now();

            try {
                const response = await fetch(test.endpoint);
                const responseTime = Date.now() - startTime;

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                
                testItem.className = 'test-item success';
                testItem.innerHTML = `
                    <strong>‚úì ${test.name}</strong><br>
                    <span class="response-time">Response time: ${responseTime}ms</span><br>
                    <details>
                        <summary>View Response Preview</summary>
                        <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
                    </details>
                `;

                return { ...test, status: 'success', responseTime, error: null };
            } catch (error) {
                const responseTime = Date.now() - startTime;
                
                testItem.className = 'test-item failed';
                testItem.innerHTML = `
                    <strong>‚úó ${test.name}</strong><br>
                    <span class="response-time">Response time: ${responseTime}ms</span><br>
                    <span style="color: #f44336;">Error: ${error.message}</span>
                `;

                return { ...test, status: 'failed', responseTime, error: error.message };
            }
        }

        async function runAllTests() {
            clearResults();
            results = [];

            const summaryDiv = document.getElementById('summary');
            summaryDiv.textContent = 'Running tests...';
            summaryDiv.className = 'summary';

            for (const test of tests) {
                const result = await testEndpoint(test);
                results.push(result);
            }

            // Update summary
            const successful = results.filter(r => r.status === 'success').length;
            const failed = results.filter(r => r.status === 'failed').length;
            const successRate = ((successful / results.length) * 100).toFixed(1);

            summaryDiv.className = `summary ${failed === 0 ? 'success' : 'failed'}`;
            summaryDiv.innerHTML = `
                <strong>Test Results:</strong><br>
                Total: ${results.length} | 
                ‚úì Success: ${successful} | 
                ‚úó Failed: ${failed} | 
                Success Rate: ${successRate}%
            `;

            if (failed === 0) {
                summaryDiv.innerHTML += '<br><br>üéâ All APIs are working! The proxy is configured correctly.';
            } else {
                summaryDiv.innerHTML += '<br><br>‚ö†Ô∏è Some APIs failed. Check the errors above and review the proxy configuration.';
            }
        }

        function clearResults() {
            ['tech4palestine', 'goodshepherd', 'worldbank', 'ocha', 'btselem'].forEach(source => {
                const div = document.getElementById(`${source}-results`);
                if (div) div.innerHTML = '';
            });
            document.getElementById('summary').textContent = '';
            results = [];
        }

        // Auto-run tests on page load
        window.addEventListener('load', () => {
            console.log('API Proxy Test page loaded. Click "Run All Tests" to begin.');
        });
    </script>
</body>
</html>
